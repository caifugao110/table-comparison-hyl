# 📊 EXCEL文件比较工具

## 📝 项目简介

本工具用于比较两个Excel文件，自动标记差异内容，包括数值变化、新增行和删除行，帮助用户快速识别两个Excel文件的数据差异。提供两种使用方式：GUI界面和Web界面。

## 🛠️ 项目依赖

### 快速安装

使用 `requirements.txt` 文件一键安装所有依赖：

```bash
pip install -r requirements.txt
```

### 外部库

- **openpyxl**: 用于Excel文件的读取、写入和样式设置
- **fastapi**: 用于构建高性能的Web API服务
- **uvicorn**: 用于运行FastAPI应用的ASGI服务器
- **python-multipart**: 用于FastAPI处理文件上传
- **customtkinter**: 用于构建现代化的GUI界面
- **pillow**: 用于GUI界面的图标处理
- **requests**: 用于API请求和版本更新检查

### 单独安装（可选）

如果需要单独安装某个依赖，可以使用以下命令：

```bash
pip install openpyxl fastapi uvicorn python-multipart customtkinter pillow requests
```

### 标准库

- **os**: 用于文件路径处理和系统操作 📁
- **subprocess**: 用于执行系统命令（设置文件只读属性、打开文件） 💻
- **stat**: 用于文件权限处理 🔒
- **datetime**: 用于生成时间戳，避免结果文件覆盖 ⏰
- **tempfile**: 用于创建临时文件和目录（Web服务器使用） 📁
- **shutil**: 用于文件复制和目录操作（Web服务器使用） 📁
- **json**: 用于处理JSON数据（Web界面使用） 📄
- **threading**: 用于多线程处理（Web服务器和GUI使用） 🧵
- **queue**: 用于线程间通信（GUI使用） 📥
- **sys**: 用于标准输出重定向（GUI使用） 💻

## 🎨 颜色标记逻辑

### 1. 数值变化 (黄色) 🟡

- **颜色代码**: `FFFF00`
- **应用场景**: 当两个文件中匹配行的相同列值不同时
- **标记方式**: 同时标记基准文件和比较文件中的差异单元格
- **处理逻辑**:
  - 基于关键字段（可自定义）匹配行
  - 比较匹配行中对应列的值
  - 只比较数据列，跳过关键字段列

### 2. 删除行 (绿色) 🟢

- **颜色代码**: `00FF00`
- **应用场景**: 基准文件中有但比较文件中没有的行
- **标记方式**: 整行标记为绿色
- **处理逻辑**:
  - 基于关键字段查找基准文件中独有的行
  - 标记整行为绿色

### 3. 新增行 (红色) 🔴

- **颜色代码**: `FF0000`
- **应用场景**: 比较文件中有但基准文件中没有的行
- **标记方式**: 整行标记为红色
- **处理逻辑**:
  - 基于关键字段查找比较文件中独有的行
  - 标记整行为红色

## 🔄 工作流程

1. **文件加载** 📂: 加载基准文件和比较文件
2. **工作表选择** 📋: 默认使用第一个工作表
3. **表头行号选择** 🔢: 允许用户自定义表头所在行号
4. **特征列选择** 🔑: 允许用户自定义用于匹配行的特征列
5. **关键字段匹配** 🔍:
   - 基于选定的特征列建立行映射关系
   - 如果无法找到特征列，使用默认行匹配
6. **差异比较** ⚖️:
   - 比较匹配行的对应列值
   - 标记数值变化的单元格
7. **新增/删除行标记** ➕➖:
   - 标记比较文件中的新增行（红色）
   - 标记基准文件中的删除行（绿色）
8. **差异结果文件生成** 📊: 将基准文件与新增行合并生成差异结果文件
9. **结果保存** 💾:
   - 将带颜色标记的结果保存到results文件夹
   - 设置结果文件为只读属性
10. **自动打开** 📤: 自动打开生成的结果文件

## 🚀 使用方法

本工具提供两种使用方式：GUI界面方式和Web界面方式。

### 方式一：GUI 界面方式 🖥️

1. **运行GUI程序** ▶️
   ```bash
   python gui/compare_excel.py
   ```

2. **使用GUI界面** 📤
   - 点击「浏览」按钮选择基准文件和比较文件
   - 点击「选择」按钮选择表头行号
   - 点击「选择」按钮选择特征列（最多支持6列）
   - 点击「开始比较」执行比较操作
   - 查看实时日志输出
   - 比较完成后自动打开结果文件

3. **GUI界面功能特点** ✨
   - 🎨 现代化的图形界面设计
   - 🌓 支持主题切换（light/dark/system）
   - 🔄 实时日志显示
   - 📋 表头行号可视化选择
   - 📝 特征列可视化选择
   - ⏹️ 支持中途停止比较
   - 🔄 自动获取最新版本信息

### 方式二：Web 界面方式 🌐

1. **启动 Web 服务器** 🚀
   ```bash
   cd web
   python fastapi_server.py
   ```

2. **访问 Web 界面** 🌐
   - 服务器启动后会自动打开浏览器
   - 浏览器地址：`http://localhost:8000`

3. **使用 Web 界面** 📤
   - 点击「选择基准文件」上传基准销售毛利分析表
   - 点击「选择比较文件」上传比较销售毛利分析表
   - 可选择性设置表头行号和特征列
   - 点击「开始比较」执行比较操作
   - 查看执行状态和结果文件
   - 点击「下载文件」下载生成的结果文件

## 📋 结果文件

- 结果文件保存到 `results` 文件夹 📁
- 生成三个结果文件：
  - 基准文件带标记：`原始文件名_my_比较结果_<时间戳>.xlsx`
  - 比较文件带标记：`原始文件名_from_比较结果_<时间戳>.xlsx`
  - 差异结果文件：`原始文件名_差异结果_<时间戳>.xlsx`
- 结果文件默认设置为只读属性 🔒
- 运行完成后自动打开生成的结果文件 📤

## 📁 项目结构

```
table-comparison-hyl/
├── from/                    # 比较文件目录 📁
│   └── .gitkeep            # Git占位文件
├── gui/                     # GUI界面相关文件 🖥️
│   └── compare_excel.py     # GUI版主程序文件 🐍
├── my/                      # 基准文件目录 📁
│   └── .gitkeep            # Git占位文件
├── results/                 # 结果文件输出目录 📁
│   └── .gitkeep            # Git占位文件
├── web/                     # Web界面相关文件 🖥️
│   ├── compare_excel_web.py  # Web版核心比较逻辑 🐍
│   ├── fastapi_server.py     # FastAPI Web服务器 🚀
│   └── index.html            # Web界面HTML文件 📄
├── .gitignore              # Git忽略文件配置
├── README.md               # 项目说明文档 📖
└── update_table_comparison.bat  # 更新脚本 📜
```

## ⚠️ 注意事项

1. **特征列**: 特征列用于判断行的增删变化，特征列内容的变化不视为数值变化，最多支持6列 🔑
2. **文件格式**: 仅支持 `.xlsx` 格式的Excel文件 📊
3. **公式处理**: 读取文件时仅加载数据，不加载公式 📈
4. **结果文件**: 自动生成带时间戳的结果文件，避免覆盖现有文件 ⏰
5. **只读属性**: 结果文件默认设置为只读，防止误修改 🔒
6. **表头行号**: 默认表头行号为3，可根据实际情况自定义调整 🔢

## 📌 扩展说明

本工具可用于比较其他类型的Excel表格，只需调整以下配置：
1. 自定义表头行号
2. 自定义特征列
3. 支持多种特征列格式（逗号分隔、空格分隔、范围格式如"1-3"）

核心比较逻辑基于行匹配和列匹配，具有良好的通用性和可扩展性。🚀

## 🔧 特征列格式支持

本工具支持多种特征列格式：
- 逗号分隔：`1,2,3`
- 空格分隔：`1 2 3`
- 范围格式：`1-3`
- 混合格式：`1,2-4,5`

## 🎯 性能优化

1. **内存优化**: 预先将所有单元格值加载到内存中，提高后续访问速度
2. **多线程处理**: GUI和Web版本均采用多线程设计，避免界面卡顿
3. **异步处理**: Web版本采用FastAPI异步处理，提高并发性能
4. **智能匹配**: 优先使用关键字段匹配，匹配失败时自动降级为行内容匹配或索引匹配

## 📄 日志功能

- **实时日志**: GUI和Web版本均提供实时日志显示
- **详细信息**: 日志包含文件加载、行匹配、差异比较、结果保存等全过程信息
- **错误提示**: 清晰的错误提示，便于问题定位

## 🌐 主题支持

GUI版本支持多种主题模式：
- **Light Mode**: 明亮主题，适合白天使用
- **Dark Mode**: 暗黑主题，适合夜间使用
- **System Mode**: 跟随系统主题，自动切换
